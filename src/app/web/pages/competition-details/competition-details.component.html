<div class="container py-4" dir="rtl">
  <!-- Loading Spinner -->
  <div *ngIf="loading" class="d-flex justify-content-center align-items-center" style="min-height: 300px;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">در حال بارگذاری...</span>
    </div>
  </div>

  <!-- Error Message -->
  <div *ngIf="error" class="alert alert-danger text-center" role="alert">
    {{ error }}
  </div>

  <!-- Competition Content -->
  <div *ngIf="competition && !loading" class="competition-content">
    <h1 class="h2 text-center mb-4 fw-bold">{{ competition.title }}</h1>

    <!-- Image Row -->
    <div class="row g-4 mb-4">
      <div class="col-md-6">
        <h2 class="h6 text-muted text-center mb-2">بنر مسابقه</h2>
        <app-image [fileId]="competition.bannerImageId" [altText]="competition.title + ' بنر'"
          className="img-fluid rounded shadow-sm" />
      </div>
      <div class="col-md-6">
        <h2 class="h6 text-muted text-center mb-2">مجوز مسابقه</h2>
        <app-image [fileId]="competition.licenseImageId" [altText]="competition.title + ' مجوز'"
          className="img-fluid rounded shadow-sm" />
      </div>
    </div>

    <!-- Competition Info Card -->
    <div class="card shadow-sm mb-4">
      <div class="card-body p-4">
        <h2 class="h5 card-title mb-3">اطلاعات مسابقه</h2>
        <div class="d-flex flex-column gap-2">
          <div class="d-flex justify-content-between">
            <span class="fw-medium">زمان برگزاری:</span>
            <span>{{ competition.date | persianDate:'jYYYY/jMM/jDD' }}</span>
          </div>
          <div class="d-flex justify-content-between">
            <span class="fw-medium">آدرس:</span>
            <span class="text-end">{{ competition.address }}</span>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <span class="fw-medium">وضعیت:</span>
            <!-- Using a function to get status-specific classes -->
            <span class="badge rounded-pill px-3 py-1 {{ getStatusBadgeClass(competition.status) }}">
              {{ getStatusText(competition.status) }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="competition.registerParams" class="card shadow-sm mb-4">
      <div class="card-body p-4">
        <h2 class="h5 card-title mb-3">شرایط ثبت نام</h2>
        <div class="mb-2">
          <strong class="d-block mb-1">{{ competition.registerParams.title }}:</strong>
          <ul class="list-unstyled ps-3">
            <li *ngFor="let val of competition.registerParams.values" class="mb-1">
              <span>{{ val.title }}</span>
              <!-- Display nested params if they exist -->
              <ul *ngIf="val.params && val.params.length > 0" class="list-unstyled ps-3">
                <li *ngFor="let subParam of val.params">
                  <span class="text-muted me-1">{{ subParam.title }}:</span>
                  <span *ngFor="let subVal of subParam.values; let last = last"
                    class="badge bg-light text-dark me-1 mb-1">{{ subVal.title }}</span>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Registration Button -->
    <!-- Registration Button - Only show if competition is active and registration is allowed -->
    <div class="text-center mb-4" *ngIf="competition.status !== 3 && competition.canRegister && !showRegistrationForm">
      <button class="btn btn-primary btn-lg px-5 shadow-sm" (click)="openRegisterSection()">
        <i class="bi bi-pencil-square me-2"></i>
        ثبت نام در مسابقه
      </button>
    </div>

    <!-- Registration Form Section - Only show if user is logged in and registration is allowed -->
    <div *ngIf="showRegistrationForm && competition.canRegister" #registrationSection class="cart shadow-sm mb-4" style="scroll-margin-top: 80px;">
      <div class="cart-body">
        <div class="competition-registration-container" id="registration-section">
          <div class="card shadow-sm mb-4">
            <div class="card-body p-4">
              <div class="card-title py-3">
                <h3 class="h5 mb-0">ثبت نام در مسابقه</h3>
              </div>

              <!-- Registration Form -->
              <form [formGroup]="registrationForm" (ngSubmit)="onSubmitRegistration()" *ngIf="!submitSuccess">
                <!-- Coach Select Input -->
                <div class="mb-3">
                  <label class="form-label">مربی</label>
                  <app-coach-select-input (coachSelected)="onCoachSelected($event)" />
                  <small class="form-text text-muted">شماره تلفن مربی خود را وارد کنید. اگر مربی شما در سیستم ثبت نشده
                    است، شماره تلفن او ثبت خواهد شد.</small>
                  <div *ngIf="registrationForm.get('coachId')?.invalid && registrationForm.get('coachId')?.touched"
                    class="form-text text-danger">
                    انتخاب مربی الزامی است.
                  </div>
                </div>

                <!-- Dynamic Parameters -->
                <div class="mb-4">
                  <app-dynamic-form [data]="competition.registerParams" (paramSelected)="onParamSelected($event)" />
                </div>

                <!-- Submit Button -->
                <div class="d-grid gap-2">
                  <button type="submit" class="btn btn-primary" [disabled]="submitting">
                    <span *ngIf="submitting" class="spinner-border spinner-border-sm me-2" role="status"
                      aria-hidden="true"></span>
                    ثبت نام
                  </button>
                </div>

                <!-- Error Message -->
                <div *ngIf="submitError" class="alert alert-danger mt-3">
                  {{ submitError }}
                </div>
              </form>

              <!-- Success Message -->
              <div *ngIf="submitSuccess && !submitError" class="alert alert-success">
                ثبت نام شما با موفقیت انجام شد.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm mb-4" *ngIf="!loading && competition?.registerParams">
      <div class="card-header bg-success text-white">
        <h3 class="h5 mb-0">
          <app-icon name="search" [size]="18" extraClass="ms-2"></app-icon>
          جستجوی دسته‌بندی
        </h3>
      </div>
      <div class="card-body">
        <app-dynamic-form
          [data]="competition.registerParams"
          (paramSelected)="onParamsSelected($event)">
        </app-dynamic-form>
        <div class="mt-3">
          <button class="btn btn-primary" (click)="searchBrackets()">
            <app-icon name="search" [size]="18" extraClass="ms-1"></app-icon>
            جستجو
          </button>
        </div>
        <div class="mt-3" *ngIf="selectedfilteredMatch && selectedfilteredMatch.hasAnyBrackets">
          <app-single-elimination-bracket [bracketKey]="selectedfilteredMatch.key" />
        </div>
      </div>
    </div>

  </div>
</div>
